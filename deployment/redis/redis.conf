# Redis Configuration for TooGoodToGo Production
# Optimized for RDB persistence with rate limiting/caching use case

# =============================================================================
# NETWORK
# =============================================================================
# Bind to all interfaces (Docker networking handles isolation)
bind 0.0.0.0

# Default Redis port
port 6379

# Disable protected mode (Docker internal network provides security)
protected-mode no

# TCP keepalive for detecting dead connections
tcp-keepalive 300

# =============================================================================
# GENERAL
# =============================================================================
# Run as daemon (disabled for Docker - container manages process)
daemonize no

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout for Docker logging
logfile ""

# Number of databases
databases 16

# =============================================================================
# RDB PERSISTENCE (User-chosen option: RDB snapshots)
# =============================================================================
# Save RDB snapshot:
#   - After 900 seconds (15 min) if at least 1 key changed
#   - After 300 seconds (5 min) if at least 10 keys changed
#   - After 60 seconds (1 min) if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000

# Stop accepting writes on RDB save error (data safety)
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# Enable RDB checksum for integrity
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Directory for RDB files
dir /data

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================
# Maximum memory (adjust based on droplet RAM - 512MB recommended for 4GB droplet)
maxmemory 512mb

# Eviction policy: remove least recently used keys when memory limit reached
# volatile-lru: Only evict keys with expire set
# allkeys-lru: Evict any key
maxmemory-policy volatile-lru

# LRU samples for eviction decision
maxmemory-samples 5

# =============================================================================
# CLIENTS
# =============================================================================
# Max simultaneous clients
maxclients 1000

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Timeout for idle clients (0 = disabled)
timeout 0

# =============================================================================
# SECURITY
# =============================================================================
# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG ""

# =============================================================================
# PERFORMANCE
# =============================================================================
# Hash optimization for small hashes
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Enable active defragmentation
activedefrag yes

# Lazy freeing to avoid blocking
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
